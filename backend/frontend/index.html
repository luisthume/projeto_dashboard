<html>

<head>
    <meta charset="UTF-8">
</head>

<body>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <select id="select" onchange="selected()">
        <option value="xmls/">XML</option>
        <option value="nfes/">NFe</option>
        <option value="datas/">Data</option>
    </select>
    <br>
    <br>
    <br>
    <button onclick="get(url, uri)">GET</button>
    <br>
    <br>
    <input id="fileInput" type="file" accept=".xml" multiple>
    <button onclick="post(url, uri)">POST</button>
    <br>
    <br>
    <select id="del_select">
        <option></option>
    </select>
    <button onclick="del_request(url, uri, id)">DELETE</button>
    <br>
    <br>
    <br>
    <br>
    <label id="demo">
    </label>
    <script>
        let fileInput = document.getElementById('fileInput');
        let select = document.getElementById('select');
        let demo = document.getElementById('demo');
        uri = select.value;
        const url = 'http://127.0.0.1:8000/api/test/'
        const token = '3e3c01657224cf495ae0f059614e4f4b08cc7e6f'

        function selected() {
            let select = document.getElementById('select');
            uri = select.value;
            console.log(uri)
        }


        function get(url, uri) {

            url = url + uri
            console.log(url)
            const xhttp = new XMLHttpRequest();
            xhttp.open("GET", url);
            xhttp.setRequestHeader('Authorization', 'Token ' + token)
            xhttp.send();
            if (uri === 'xmls/') {
                xhttp.onreadystatechange = (e) => {
                    console.log(JSON.parse(xhttp.response))

                    let data = JSON.parse(xhttp.responseText)
                        //document.getElementById("demo").innerHTML = data.results[0].xml_info[0].id;
                    $('<label id="demo"></label>').replaceAll('#demo');
                    $.each(data.results, function(i, data) {
                        var div_data = `<ul>
                            <li><h4>ID: ${data.id}</h4></li>
                            <ul>
                            <li>XML: ${data.xml}</li>
                            <p></p>
                            <ul><li><h4>XML INFO:</h4><li>
                                <li>${data.xml_info[0].nfe_id}</li>                            
                                <li>${data.xml_info[0].dest_cnpj}</li>
                                <li>${data.xml_info[0].dest_name}</li>
                                <li>${data.xml_info[0].emit_cnpj}</li>
                                <li>${data.xml_info[0].emit_name}</li>
                                <li>${data.xml_info[0].exit_date}</li>
                                <li>${data.xml_info[0].valor_original_total}</li>
                            </ul>
                            <p></p>                        
                            <li>CREATION DATE: ${data.dt_creation}</li>
                            <li>UPDATED DATE: ${data.dt_updated}</li>
                            </ul>
                            </ul>`;
                        $(div_data).appendTo('#demo');
                    });
                }
            } else if (uri === 'nfes/') {
                xhttp.onreadystatechange = (e) => {

                    console.log(JSON.parse(xhttp.response))

                    let data = JSON.parse(xhttp.responseText)
                    $('<label id="demo"></label>').replaceAll('#demo');
                    $.each(data.results, function(i, data) {
                        var div_data = `<ul>
                                <li>ID: ${data.id}</li>                            
                                <ul>
                                <li>CNPJ DESTINATÁRIO: ${data.dest_cnpj}</li>
                                <li>NOME DO CNPJ DESTINATÁRIO: ${data.dest_name}</li>
                                <li>CNPJ EMISSOR: ${data.emit_cnpj}</li>
                                <li>NOME DO CNPJ EMISSOR: ${data.emit_name}</li>
                                <li>DATA: ${data.exit_date}</li>
                                <li>VALOR TOTAL: R\$ ${data.valor_original_total}</li>
                                </ul>
                            </ul>`;
                        $(div_data).appendTo('#demo');
                    });
                }
            }


        }

        function post(url, uri) {

            url = url + uri
            var formData = new FormData();
            files = $('#fileInput')[0].files
            for (let i = 0; i < files.length; i++) {
                formData.append('xml', files[i]);
            }
            const xhttp = new XMLHttpRequest();
            xhttp.open("POST", url, true);
            xhttp.setRequestHeader('Content-Type', 'multipart/form-data; boundary=X-INSOMNIA-BOUNDARY')
            xhttp.setRequestHeader('Authorization', 'Token ' + token)

            xhttp.send([formData]);

            xhttp.onload = (e) => {
                console.log(xhttp.responseText)
            }

            return xhttp
        }

        function del_request(url, uri, id) {

            del_select = document.getElementById('del_select');
            id = del_select.value
            url = url + uri + id
            console.log(url)
            const xhttp = new XMLHttpRequest();
            xhttp.open("DELETE", url);
            xhttp.setRequestHeader('Authorization', 'Token ' + token)
            xhttp.send();
            xhttp.onreadystatechange = (e) => {
                get_del_selection();
            }

            return xhttp
        }

        function get_del_selection() {
            $.ajax({
                url: url + 'xmls/',
                type: "GET",
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Token ' + token);
                },
                success: function(data) {
                    $('<select id="del_select"><option></option></select>').replaceAll('#del_select');
                    $.each(data.results, function(i, data) {
                        var div_data = "<option value=" + data.id + ">" + data.id + "</option>";
                        $(div_data).appendTo('#del_select');
                    });

                    return data
                },
                error: function(error) {
                    console.log(error)
                }
            });
        };

        function files_to_formData() {
            var formData = new FormData();
            let fileInput = document.getElementById('fileInput');
            const files = fileInput.files

            for (let i = 0; i < files.length; i++) {
                formData.append('xml', files[i]);
            }
            return formData
        }

        function files_to_array() {
            var ukeys = new Array()
            let files = $("#fileInput").prop('files');
            for (let i = 0; i < files.length; i++) {
                ukeys.push(files[i]);
            }
            return ukeys
        }

        function post2(url, uri, formData) {
            $.ajax({
                type: "POST",
                url: url + uri,
                data: formData,
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Content-Type', 'multipart/form-data; boundary=X-INSOMNIA-BOUNDARY')
                    xhr.setRequestHeader('Authorization', 'Token ' + token);
                },
                success: function(data) {
                    return data
                },
                error: function(error) {
                    console.log('Error: ' + error.responseText)
                }
            });
        };

        $(document).ready(get_del_selection());
    </script>
</body>

</html>