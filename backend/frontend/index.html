<html>

<head>
    <meta charset="UTF-8">
    <style>
        table,
        td,
        th {
            border: 1px solid black;
            font-size: medium;
            text-align: center;
        }
        
        th,
        td {
            padding: 5px;
        }
        
        table {
            border-collapse: collapse;
            width: 85%;
        }
        
        th {
            height: 40px;
        }
    </style>
</head>

<body>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <select id="select" onchange="selected()">
        <option value="xmls/">XML</option>
        <option value="nfes/">NFe</option>
        <option value="datas/">Data</option>
    </select>
    <br>
    <br>
    <br>
    <button onclick="get(url, 'xmls/')">GET</button>
    <br>
    <br>
    <input id="fileInput" type="file" accept=".xml" multiple>
    <button onclick="post(url, uri)">POST</button>
    <br>
    <br>
    <select id="del_select">
        <option></option>
    </select>
    <button onclick="del_request(url, uri, id)">DELETE</button>
    <br>
    <br>
    <br>
    <br>
    <label id="demo">
    </label>
    <script>
        let fileInput = document.getElementById('fileInput');
        let select = document.getElementById('select');
        let demo = document.getElementById('demo');
        uri = select.value;
        const url = 'http://127.0.0.1:8000/api/test/'
        const token = '96c1071ef09fdc6e0c5eb41fd6ea1c7491d6d404'

        function selected() {
            let select = document.getElementById('select');
            uri = select.value;
            console.log(uri)
        }

        function xmls_to_demo(data) {
            $('<table id="demo"><tr><th>ID</th><th>XML</th><th>XML INFO</th><th>CREATION DATE</th><th>UPDATED DATE</th></tr>').replaceAll('#demo');
            $.each(data.results, function(i, data) {
                var div_data = `<tr>
                            <td>${data.id}</td>
                            <td>${data.xml}</td>
                            <td>
                            <ul style="font-size: small;">
                                <li>NFe: ${data.xml_info[0].nfe_id}</li>                            
                                <li>CNPJ VENDEDOR: ${data.xml_info[0].dest_cnpj}</li>
                                <li>NOME DO CNPJ VENDEDOR: ${data.xml_info[0].dest_name}</li>
                                <li>CNPJ COMPRADOR: ${data.xml_info[0].emit_cnpj}</li>
                                <li>NOME DO CNPJ COMPRADOR: ${data.xml_info[0].emit_name}</li>
                                <li>DATA: ${data.xml_info[0].exit_date}</li>
                                <li>VALOR TOTAL: ${data.xml_info[0].valor_original_total}</li>
                            </ul>
                            </td>
                            <td>${data.dt_creation}</td>
                            <td>${data.dt_updated}</td>
                            </tr></table>`;
                $(div_data).appendTo('#demo');
            });
        }

        function nfe_to_demo(data) {
            $('<table id="demo"><tr><th>ID</th><th>CNPJ VENDEDOR</th><th>NOME DO CNPJ VENDEDOR</th><th>CNPJ COMPRADOR</th><th>NOME DO CNPJ COMPRADOR</th><th>DATA</th><th>VALOR TOTAL</th></tr></table>').replaceAll('#demo');
            $.each(data.results, function(i, data) {
                var div_data = `     
                                <tr>
                                <th>${data.id}</th>
                                <td>${data.dest_cnpj}</td>
                                <td>${data.dest_name}</td>
                                <td>${data.emit_cnpj}</td>
                                <td>${data.emit_name}</td>
                                <td>${data.exit_date}</td>
                                <td>R\$ ${data.valor_original_total}</td>
                                </tr>`;
                $(div_data).appendTo('#demo');
            });
        }

        function datas_to_demo(data) {
            $('<table id="demo"><tr><th>CNPJ VENDEDOR</th><th>NOME DO CNPJ VENDEDOR</th><th>CNPJ COMPRADOR</th><th>NOME DO CNPJ COMPRADOR</th><th>VALOR TOTAL</th><th>MÉDIA DE OPERAÇÃO</th></tr></table>').replaceAll('#demo');
            $.each(data.results, function(i, data) {
                var div_data = `     
                                <tr>                                    
                                <td>${data.dest_cnpj}</td>
                                <td>${data.dest_name}</td>
                                <td>${data.emit_cnpj}</td>
                                <td>${data.emit_name}</td>
                                <td>R\$${data.valor_total}</td>
                                <td>R\$ ${data.operation_mean}</td>
                                </tr>`;
                $(div_data).appendTo('#demo');
            });
        }


        function get(url, uri) {

            url = url + uri
            console.log(url)
            const xhttp = new XMLHttpRequest();
            xhttp.open("GET", url);
            xhttp.setRequestHeader('Authorization', 'Token ' + token)
            xhttp.send();
            if (uri === 'xmls/') {
                xhttp.onreadystatechange = (e) => {

                    let data = JSON.parse(xhttp.responseText)
                    xmls_to_demo(data)

                }
            } else if (uri === 'nfes/') {
                xhttp.onreadystatechange = (e) => {

                    let data = JSON.parse(xhttp.responseText)
                    nfe_to_demo(data)

                }
            } else if (uri === 'datas/') {
                xhttp.onreadystatechange = (e) => {

                    console.log(JSON.parse(xhttp.responseText))
                    let data = JSON.parse(xhttp.responseText)
                    datas_to_demo(data)

                }
            }

        }

        function post(url, uri) {

            url = url + uri
            var formData = new FormData();
            files = $('#fileInput')[0].files
            for (let i = 0; i < files.length; i++) {
                formData.append('xml', files[i]);
            }
            const xhttp = new XMLHttpRequest();
            xhttp.open("POST", url, true);
            xhttp.setRequestHeader('Content-Type', 'multipart/form-data; boundary=X-INSOMNIA-BOUNDARY')
            xhttp.setRequestHeader('Authorization', 'Token ' + token)

            xhttp.send([formData]);

            xhttp.onload = (e) => {
                console.log(xhttp.responseText)
            }

            return xhttp
        }

        function del_request(url, uri, id) {

            del_select = document.getElementById('del_select');
            id = del_select.value
            url = url + uri + id
            console.log(url)
            const xhttp = new XMLHttpRequest();
            xhttp.open("DELETE", url);
            xhttp.setRequestHeader('Authorization', 'Token ' + token)
            xhttp.send();
            xhttp.onreadystatechange = (e) => {
                get_del_selection();
            }

            return xhttp
        }

        function get_del_selection() {
            $.ajax({
                url: url + 'xmls/',
                type: "GET",
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Token ' + token);
                },
                success: function(data) {
                    $('<select id="del_select"><option></option></select>').replaceAll('#del_select');
                    $.each(data.results, function(i, data) {
                        var div_data = "<option value=" + data.id + ">" + data.id + "</option>";
                        $(div_data).appendTo('#del_select');
                    });

                    return data
                },
                error: function(error) {
                    console.log(error)
                }
            });
        };

        function files_to_formData() {
            var formData = new FormData();
            let fileInput = document.getElementById('fileInput');
            const files = fileInput.files

            for (let i = 0; i < files.length; i++) {
                formData.append('xml', files[i]);
            }
            return formData
        }

        function files_to_array() {
            var ukeys = new Array()
            let files = $("#fileInput").prop('files');
            for (let i = 0; i < files.length; i++) {
                ukeys.push(files[i]);
            }
            return ukeys
        }

        function post2(url, uri, formData) {
            $.ajax({
                type: "POST",
                url: url + uri,
                data: formData,
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Content-Type', 'multipart/form-data; boundary=X-INSOMNIA-BOUNDARY')
                    xhr.setRequestHeader('Authorization', 'Token ' + token);
                },
                success: function(data) {
                    return data
                },
                error: function(error) {
                    console.log('Error: ' + error.responseText)
                }
            });
        };

        $(document).ready(get_del_selection());
    </script>
</body>

</html>